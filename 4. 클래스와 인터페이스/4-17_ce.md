# 변경 가능성을 최소화하라

## 불변 클래스

- 인스턴스의 내부 값을 수정할 수 없는 클래스
- 불변 인스턴스 정보는 고정되어 객체가 파괴되는 순간까지 절대 달라지지 않는다.
- e.g. String, BigInteger, BigDecimal, 기본 타입의 박싱 클래스

### 장점

- 가변 클래스보다 설계/구현이 쉽다.

- 가변 클래스보다 안전하다.
  - 스레드 안전하여 따로 동기화가 필요 없다.
- 여러 스레드가 동시에 사용해도 절대 훼손되지 않는다.
- 불변 객체에 그 어떤 스레드도 다른 스레드에 영향을 주지 않으니 불변 객체는 안심하고 공유할 수 있다.

  - 따라서 한 번 만든 인스턴스는 최대한 재활용하자.
  - 가장 쉬운 재활용 방법은 public static final로 선언하는 것

- 자주 사용되는 인스턴스를 캐싱하여 정적 팩토리를 제공할 수 있다.

  - e.g. BigInteger, 기본 타입의 박싱 클래스
  - 정적 팩토리를 사용하면 여러 클라이언트에서 인스턴스를 공유할 수 있게 되고, 메모리 사용량과 가비지 컬렉션 비용이 줄어들게 된다.

- 불변 객체는 공유할 수 있기 떄문에 방어적 복사가 필요없다. (어차피 복사해봐야 원본과 똑같음)

  - 굳이 clone이나 복사 생성자를 제공하지 않아도 된다.

- 객체를 만들 때, 구성요소가 불변 객체이면 좋다.
  - 객체의 구조가 복잡해져도 불변식을 유지하기 쉽기 때문이다.

### 불변 클래스를 만들기 위한 규칙

1. 객체의 상태를 변경하는 메서드를 제공하지 않는다.

   - setter는 최대한 사용하지 말 것

2. 클래스를 확장할 수 없도록 한다.

   - final 클래스로 선언
   - 모든 생성자를 private 혹은 package-private로 만들고, public 정적 팩토리를 제공하는 방법도 있다. (더 유연한 방법)

3. 모든 필드를 final로 선언한다.
4. 모든 필드를 private로 선언한다.
   - 필드가 참조하는 가변 객체를 클라이언트가 직접 접근하는 일을 막아줌
5. 자신 외에는 내부의 가변 컴포넌트에 접근할 수 없도록 한다.
   - 가변 객체를 참조하는 필드가 하나라도 있다면, 클라이언트에서 해당 객체의 참조에 접근하지 못하도록 해야한다.
   - 생성자, 접근자에서 방어적 복사를 수행하라.

### 단점

- 값이 다르면 다른 독립된 객체로 만들어야 한다.
  - 값의 가짓수가 많으면 이를 모두 만드는데 큰 비용이 들어간다.
    <br/> -> 이를 해결하기 위해 `package-private의 가변 동반 클래스로 제공`하는 방법이 있다.
    <br/> -> e.g. StringBuffer

### 정리

- setter는 최대한 사용하지 말 것
- 변경할 필드를 제외하고는 모두 private final로 선언할 것
- 생성자는 초기화가 완벽히 끝나 불변식이 완료된 상태의 객체를 생성해야 한다.
